<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-GEOBig5">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bank Transaction Manager</title>
  <!-- Add SheetJS library for Excel file parsing -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"></script>
  <!-- Add jsPDF library for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- Add jsPDF AutoTable plugin -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f2f5;
      color: #333;
    }

    h1,
    h2 {
      color: #1f2c3d;
      text-align: center;
      margin-bottom: 25px;
      font-weight: 600;
    }

    .controls-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding: 15px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.07);
      transition: box-shadow 0.3s ease;
    }

    .controls-container:hover {
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }

    .date-filter-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .date-filter-container label {
      font-size: 0.9em;
      color: #555;
    }

    .date-filter-container input[type="date"],
    .date-filter-container button {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 0.9em;
    }

    .date-filter-container button {
      background-color: #5dade2;
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .date-filter-container button:hover {
      background-color: #3498db;
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      background-color: #fff;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    table:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    th,
    td {
      border-bottom: 1px solid #e0e0e0;
      padding: 10px 15px;
      text-align: left;
      vertical-align: middle;
      font-size: 0.9em;
    }

    th {
      background-color: #3498db;
      color: #ffffff;
      font-weight: 600;
      font-size: 0.9em;
      border-top: none;
      border-bottom-width: 2px;
    }

    td:first-child,
    th:first-child {
      border-left: none;
    }

    td:last-child,
    th:last-child {
      border-right: none;
      text-align: center;
    }

    tr:nth-of-type(even) {
      background-color: #f9fafb;
    }

    tr:hover td {
      background-color: #eaf5ff;
    }

    tr {
      transition: all 0.2s ease;
    }

    tbody tr:hover {
      transform: translateX(5px);
    }

    button {
      cursor: pointer;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      color: white;
      font-size: 0.9em;
      transition: all 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 7px rgba(0, 0, 0, 0.15);
    }

    .btn-split {
      background-color: #5dade2;
      min-width: 40px;
      text-align: center;
    }

    .btn-split.active {
      background-color: #2ecc71;
    }

    .btn-delete {
      background-color: #e74c3c;
    }

    .btn-delete:hover {
      background-color: #c0392b;
    }

    input[type="file"] {
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #fff;
      font-size: 0.9em;
      transition: border-color 0.2s ease;
    }

    input[type="file"]:hover {
      border-color: #3498db;
    }

    .total-amount {
      margin-top: 30px;
      text-align: right;
      font-weight: 600;
      font-size: 1.4em;
      color: #1f2c3d;
      padding: 15px;
      background-color: #eaf5ff;
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    .total-amount:hover {
      background-color: #d2e8ff;
      transform: scale(1.01);
    }

    .file-label {
      font-weight: bold;
      margin-right: 5px;
    }

    .grand-total {
      margin: 50px auto 20px;
      padding: 20px;
      background: linear-gradient(135deg, #3498db, #1abc9c);
      color: white;
      border-radius: 10px;
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
      text-align: center;
      font-size: 1.8em;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .grand-total:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .export-container {
      display: flex;
      justify-content: center;
      margin: 40px 0;
    }

    .btn-export {
      background-color: #2ecc71;
      padding: 12px 25px;
      font-size: 1.1em;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .btn-export:hover {
      background-color: #27ae60;
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out forwards;
    }

    h1,
    h2 {
      position: relative;
      overflow: hidden;
    }

    h1::after,
    h2::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(to right, transparent, #3498db, transparent);
      transform: translateX(-100%);
      animation: slideIn 1.5s ease-out forwards;
    }

    @keyframes slideIn {
      to {
        transform: translateX(0);
      }
    }
  </style>
</head>

<body>
  <h1>Bank Transaction Manager</h1>

  <div class="controls-container">
    <div>
      <label for="visaCsvInput" class="file-label">VISA:</label>
      <input type="file" id="visaCsvInput" accept=".csv" multiple>
    </div>
    <div>
      <label for="amexCsvInput" class="file-label">AMEX:</label>
      <input type="file" id="amexCsvInput" accept=".xls, .xlsx" multiple>
    </div>
    <div>
      <label for="rogersCsvInput" class="file-label">ROGERS:</label>
      <input type="file" id="rogersCsvInput" accept=".csv" multiple>
    </div>
    <div class="date-filter-container">
      <label for="startDate">From:</label>
      <input type="date" id="startDate">
      <label for="endDate">To:</label>
      <input type="date" id="endDate">
      <button id="filterButton">Filter</button>
      <button id="clearFilterButton">Clear Filter</button>
      <button id="showAllButton">Show All</button>
    </div>
  </div>

  <h2>VISA Transactions</h2>
  <table id="visaTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Name</th>
        <th>Expenses</th>
        <th>Split (P)</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="visaTableBody">
      <!-- Data will be inserted here by JavaScript -->
    </tbody>
  </table>
  <div class="total-amount">
    Total VISA Expenses: <span id="visaTotalAmount">0.00</span>
  </div>

  <h2>AMEX Transactions</h2>
  <table id="amexTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Name</th>
        <th>Expenses</th>
        <th>Split (P)</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="amexTableBody">
      <!-- Data will be inserted here by JavaScript -->
    </tbody>
  </table>
  <div class="total-amount">
    Total AMEX Expenses: <span id="amexTotalAmount">0.00</span>
  </div>

  <h2>ROGERS Transactions</h2>
  <table id="rogersTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Name</th>
        <th>Expenses</th>
        <th>Split (P)</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="rogersTableBody">
      <!-- Data will be inserted here by JavaScript -->
    </tbody>
  </table>
  <div class="total-amount">
    Total ROGERS Expenses: <span id="rogersTotalAmount">0.00</span>
  </div>

  <div class="grand-total fade-in">
    GRAND TOTAL: <span id="grandTotalAmount">0.00</span>
  </div>

  <div class="export-container">
    <button id="exportPdfBtn" class="btn-export">Export as PDF</button>
  </div>

  <script>
    // Global variables and DOM elements
    let transactions = [];
    let amexTransactions = [];
    let rogersTransactions = [];
    const fileInput = document.getElementById('visaCsvInput');
    const amexFileInput = document.getElementById('amexCsvInput');
    const rogersFileInput = document.getElementById('rogersCsvInput');
    const tableBody = document.getElementById('visaTableBody');
    const amexTableBody = document.getElementById('amexTableBody');
    const rogersTableBody = document.getElementById('rogersTableBody');
    const totalAmountSpan = document.getElementById('visaTotalAmount');
    const amexTotalAmountSpan = document.getElementById('amexTotalAmount');
    const rogersTotalAmountSpan = document.getElementById('rogersTotalAmount');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const filterBtn = document.getElementById('filterButton');
    const clearFilterBtn = document.getElementById('clearFilterButton');
    const showAllBtn = document.getElementById('showAllButton');

    // Initialize event listeners
    fileInput.addEventListener('change', handleFileUpload);
    amexFileInput.addEventListener('change', handleAmexFileUpload);
    rogersFileInput.addEventListener('change', handleRogersFileUpload);
    filterBtn.addEventListener('click', function () {
      renderTableWithFilters();
      renderAmexTableWithFilters();
      renderRogersTableWithFilters();
      updateGrandTotal();
    });
    clearFilterBtn.addEventListener('click', function () {
      startDateInput.value = '';
      endDateInput.value = '';
      renderTableWithFilters();
      renderAmexTableWithFilters();
      renderRogersTableWithFilters();
      updateGrandTotal();
    });
    showAllBtn.addEventListener('click', function () {
      startDateInput.value = '';
      endDateInput.value = '';
      renderTableWithFilters();
      renderAmexTableWithFilters();
      renderRogersTableWithFilters();
      updateGrandTotal();
      alert('Showing all transactions: ' + transactions.length + ' VISA, ' + amexTransactions.length + ' AMEX, and ' + rogersTransactions.length + ' ROGERS');
    });

    document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);

    // Handle VISA file upload
    function handleFileUpload(e) {
      const files = e.target.files;
      if (!files || files.length === 0) return;

      // Process each file
      let processedCount = 0;
      for (let i = 0; i < files.length; i++) {
        const reader = new FileReader();

        reader.onload = function (e) {
          processCSV(e.target.result);
          processedCount++;

          // When all files are processed, render the table
          if (processedCount === files.length) {
            renderTableWithFilters();
          }
        };

        reader.readAsText(files[i]);
      }

      // Reset file input so same file can be uploaded again
      fileInput.value = '';
    }

    // Handle AMEX file upload (XLS format)
    function handleAmexFileUpload(e) {
      const files = e.target.files;
      if (!files || files.length === 0) return;

      // Process each file
      let processedCount = 0;
      for (let i = 0; i < files.length; i++) {
        const reader = new FileReader();

        reader.onload = function (e) {
          try {
            // Parse Excel file using SheetJS
            const data = e.target.result;
            const workbook = XLSX.read(data, { type: 'array' });

            // Get the first sheet
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];

            // Convert to array of arrays (first 15 rows will be skipped later)
            const excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: false });

            processAmexExcel(excelData);
            processedCount++;

            // When all files are processed, render the table
            if (processedCount === files.length) {
              renderAmexTableWithFilters();
            }
          } catch (error) {
            console.error("Error processing AMEX Excel file:", error);
            alert('Error processing AMEX Excel file. Please check the format.');
          }
        };

        reader.readAsArrayBuffer(files[i]);
      }

      // Reset file input so same file can be uploaded again
      amexFileInput.value = '';
    }

    // Process AMEX Excel data
    function processAmexExcel(excelData) {
      // Data starts from row 18 (index 17), row 17 (index 16) is the header
      if (excelData.length <= 17) { // Need at least one data row + header
        alert('AMEX Excel file seems to be in incorrect format or too short. It must have data starting from row 18.');
        return;
      }

      // Start from row 18 (index 17)
      for (let i = 17; i < excelData.length; i++) {
        const row = excelData[i];
        // Expected: Date (0), Desc (1), Skip (2), Cardmember (3), Amount (4)
        if (!Array.isArray(row) || row.length < 5) {
          console.warn(`Skipping row ${i + 1} due to insufficient columns. Expected at least 5 columns.`, row);
          continue;
        }

        // 1. Date: First column (index 0)
        let date = null;
        try {
          if (row[0]) {
            if (typeof row[0] === 'number') {
              date = new Date(Math.round((row[0] - 25569) * 86400 * 1000));
            } else {
              date = new Date(String(row[0]).trim());
            }
            if (isNaN(date.getTime())) {
              console.warn(`Skipping row ${i + 1} due to invalid date in column 1: ${row[0]}`);
              continue;
            }
          } else {
            console.warn(`Skipping row ${i + 1} due to missing date in column 1.`);
            continue;
          }
        } catch (err) {
          console.warn(`Error parsing date for row ${i + 1}: ${row[0]}`, err);
          continue;
        }

        // 2. Name: Combine Description (index 1) and Cardmember (index 3)
        const description = row[1] ? String(row[1]).trim() : '';
        const cardmember = row[3] ? String(row[3]).trim() : ''; // Cardmember is now at index 3
        let name = description;
        if (cardmember) {
          name = description ? `${description} - ${cardmember}` : cardmember;
        }
        if (!name && !description) { // Only skip if both are truly empty, allowing for just cardmember or just desc if one is missing
          console.warn(`Skipping row ${i + 1} due to missing Description (col 2) and Cardmember (col 4).`);
          continue;
        }

        // 3. Amount: Fifth column (index 4)
        let expense = 0;
        if (row[4] !== undefined && row[4] !== null) {
          let amountStr = String(row[4]).trim();
          // More robust removal of leading dollar sign and any internal commas
          if (amountStr.startsWith('$')) {
            amountStr = amountStr.substring(1);
          }
          amountStr = amountStr.replace(/,/g, ''); // Remove commas
          expense = parseFloat(amountStr);
        } else {
          console.warn(`Skipping row ${i + 1} due to missing Amount in column 5.`);
          continue;
        }

        if (isNaN(expense)) {
          console.warn(`Skipping row ${i + 1} due to invalid Amount in column 5: ${row[4]}`);
          continue;
        }

        expense = Math.abs(expense);

        // Check for duplicate
        const isDuplicate = amexTransactions.some(t =>
          t.date.toDateString() === date.toDateString() &&
          t.name === name &&
          Math.abs(t.originalExpense - expense) < 0.01
        );

        if (!isDuplicate) {
          amexTransactions.push({
            id: 'amex_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9),
            date: date,
            name: name,
            expense: expense,
            originalExpense: expense,
            isSplit: false
          });
        } else {
          console.log(`Skipping duplicate AMEX transaction: ${date.toLocaleDateString()}, ${name}, ${expense.toFixed(2)}`);
        }
      }
    }

    // Render AMEX table with filters applied
    function renderAmexTableWithFilters() {
      // Clear the table first
      amexTableBody.innerHTML = '';

      // Get filter dates
      const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
      const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

      // Adjust date ranges to include full days
      if (startDate) startDate.setHours(0, 0, 0, 0);
      if (endDate) endDate.setHours(23, 59, 59, 999);

      // Filter transactions
      const filteredTransactions = amexTransactions.filter(t => {
        if (startDate && t.date < startDate) return false;
        if (endDate && t.date > endDate) return false;
        return true;
      });

      // Render each transaction
      filteredTransactions.forEach(renderAmexTransaction);

      // Update total
      updateAmexTotal(filteredTransactions);
    }

    // Render a single AMEX transaction row
    function renderAmexTransaction(transaction) {
      const row = document.createElement('tr');

      // Date cell
      const dateCell = document.createElement('td');
      dateCell.textContent = transaction.date.toLocaleDateString();
      row.appendChild(dateCell);

      // Name cell
      const nameCell = document.createElement('td');
      nameCell.textContent = transaction.name;
      row.appendChild(nameCell);

      // Expense cell
      const expenseCell = document.createElement('td');
      expenseCell.textContent = transaction.expense.toFixed(2);
      row.appendChild(expenseCell);

      // Split button cell
      const splitCell = document.createElement('td');
      const splitBtn = document.createElement('button');
      splitBtn.textContent = 'P';
      splitBtn.className = transaction.isSplit ? 'btn-split active' : 'btn-split';
      splitBtn.onclick = function () {
        toggleAmexSplit(transaction.id);
      };
      splitCell.appendChild(splitBtn);
      row.appendChild(splitCell);

      // Delete button cell
      const deleteCell = document.createElement('td');
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.className = 'btn-delete';
      deleteBtn.onclick = function () {
        deleteAmexTransaction(transaction.id);
      };
      deleteCell.appendChild(deleteBtn);
      row.appendChild(deleteCell);

      // Add row to table with animation
      addRowAnimation(row);
      amexTableBody.appendChild(row);
    }

    // Toggle split status of an AMEX transaction
    function toggleAmexSplit(id) {
      const index = amexTransactions.findIndex(t => t.id === id);
      if (index === -1) return;

      const transaction = amexTransactions[index];
      transaction.isSplit = !transaction.isSplit;

      if (transaction.isSplit) {
        transaction.expense = transaction.originalExpense / 2;
      } else {
        transaction.expense = transaction.originalExpense;
      }

      // Re-render table to reflect changes
      renderAmexTableWithFilters();
    }

    // Delete an AMEX transaction
    function deleteAmexTransaction(id) {
      if (!confirm('Are you sure you want to delete this AMEX transaction?')) {
        return;
      }

      const index = amexTransactions.findIndex(t => t.id === id);
      if (index === -1) return;

      amexTransactions.splice(index, 1);
      renderAmexTableWithFilters();
    }

    // Update AMEX total amount display
    function updateAmexTotal(filteredTransactions) {
      const total = filteredTransactions.reduce((sum, t) => sum + t.expense, 0);
      amexTotalAmountSpan.textContent = total.toFixed(2);
      updateGrandTotal();
    }

    // Handle ROGERS file upload (assuming CSV)
    function handleRogersFileUpload(e) {
      const files = e.target.files;
      if (!files || files.length === 0) return;

      let processedCount = 0;
      for (let i = 0; i < files.length; i++) {
        const reader = new FileReader();
        reader.onload = function (event) {
          processRogersCSV(event.target.result);
          processedCount++;
          if (processedCount === files.length) {
            renderRogersTableWithFilters();
          }
        };
        reader.readAsText(files[i]);
      }
      rogersFileInput.value = '';
    }

    // Process ROGERS CSV content
    function processRogersCSV(csvContent) {
      const lines = csvContent.split('\n');
      console.log(`Rogers CSV: Total lines read: ${lines.length}`);

      // Assuming the first line is the header, data starts from the second line (index 1)
      for (let i = 1; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) {
          console.log(`Rogers CSV: Empty line at row ${i + 1}, skipping`);
          continue;
        }

        // Split the CSV properly, handling quoted values containing commas
        let columns = [];
        let currentCol = '';
        let inQuotes = false;

        for (let j = 0; j < line.length; j++) {
          const char = line[j];

          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            columns.push(currentCol);
            currentCol = '';
          } else {
            currentCol += char;
          }
        }
        // Don't forget to add the last column
        columns.push(currentCol);

        // Clean up the columns (remove quotes and trim)
        columns = columns.map(col => col.trim().replace(/^"|"$/g, ''));

        console.log(`Rogers CSV: Row ${i + 1}, Columns: ${columns.length}, Date: ${columns[0]}, Desc: ${columns[7]}, Amount: ${columns[12]}`);

        // Date (YYYY-MM-DD) is in column 0 (A)
        let date = null;
        try {
          if (columns[0]) { // Check if date column exists and is not empty
            // Fix date parsing to prevent timezone issues causing date to be off by one day
            const dateParts = columns[0].split('-');
            if (dateParts.length === 3) {
              // Create date using year, month (0-based), day with noon time to avoid timezone issues
              date = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]), 12, 0, 0);
            } else {
              date = new Date(columns[0] + 'T12:00:00'); // Add noon time to avoid date shift
            }

            if (isNaN(date.getTime())) {
              console.warn(`Rogers CSV: Skipping row ${i + 1} due to invalid date in column A: ${columns[0]}`);
              continue;
            }
          } else {
            console.warn(`Rogers CSV: Skipping row ${i + 1} due to missing date in column A.`);
            continue;
          }
        } catch (err) {
          console.warn(`Rogers CSV: Error parsing date for row ${i + 1}: ${columns[0]}`, err);
          continue;
        }

        // Merchant Name (Description) is in column H (index 7)
        const merchantName = columns.length > 7 && columns[7] ? columns[7].trim() : 'Unknown Merchant';

        // Amount is in column M (index 12)
        let expense = 0;
        if (columns.length > 12) {
          let amountStr = columns[12] ? String(columns[12]).trim() : '';

          // Log the raw amount string
          console.log(`Rogers CSV: Row ${i + 1}, Raw amount value: "${amountStr}"`);

          // Check if it's empty or just contains a dash or other non-numeric
          if (!amountStr || amountStr === '-') {
            console.log(`Rogers CSV: Row ${i + 1} has empty or dash-only amount value, treating as $0.00`);
            expense = 0;
          } else {
            // Process normal amount
            amountStr = amountStr.replace(/\$|,/g, ''); // Remove $ and commas

            // Handle negative values more carefully
            const isNegative = amountStr.includes('-');
            amountStr = amountStr.replace(/-/g, ''); // Remove minus signs

            expense = parseFloat(amountStr);
            if (isNaN(expense)) {
              console.warn(`Rogers CSV: Non-critical error parsing amount in row ${i + 1}: "${columns[12]}", treating as $0.00`);
              expense = 0;
            } else {
              // Set negative if needed - keep the original sign
              if (isNegative) {
                expense = -expense;
              }
            }
          }
        } else {
          console.warn(`Rogers CSV: Missing amount column in row ${i + 1}, treating as $0.00. Columns available: ${columns.length}`);
          expense = 0;
        }

        console.log(`Rogers CSV: Successfully processed row ${i + 1}: ${date.toLocaleDateString()}, "${merchantName}", $${expense.toFixed(2)}`);

        const transactionName = merchantName; // Simplified transaction name

        const isDuplicate = rogersTransactions.some(t =>
          t.date.toDateString() === date.toDateString() &&
          t.name === transactionName &&
          Math.abs(t.originalExpense - expense) < 0.01
        );

        if (!isDuplicate) {
          rogersTransactions.push({
            id: 'rogers_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9),
            date: date,
            name: transactionName,
            expense: expense,
            originalExpense: expense,
            isSplit: false
          });
          console.log(`Rogers CSV: Added transaction for "${transactionName}" on ${date.toLocaleDateString()}`);
        } else {
          console.log(`Rogers CSV: Skipping duplicate transaction for "${transactionName}" on ${date.toLocaleDateString()}`);
        }
      }
    }

    // Render ROGERS table with filters applied
    function renderRogersTableWithFilters() {
      rogersTableBody.innerHTML = '';
      const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
      const endDate = endDateInput.value ? new Date(endDateInput.value) : null;
      if (startDate) startDate.setHours(0, 0, 0, 0);
      if (endDate) endDate.setHours(23, 59, 59, 999);

      const filteredTransactions = rogersTransactions.filter(t => {
        if (startDate && t.date < startDate) return false;
        if (endDate && t.date > endDate) return false;
        return true;
      });

      filteredTransactions.forEach(renderRogersTransaction);
      updateRogersTotal(filteredTransactions);
    }

    // Render a single ROGERS transaction row
    function renderRogersTransaction(transaction) {
      const row = document.createElement('tr');
      row.insertCell().textContent = transaction.date.toLocaleDateString();
      row.insertCell().textContent = transaction.name;
      const expenseCell = row.insertCell();
      expenseCell.textContent = transaction.expense.toFixed(2);

      const splitCell = row.insertCell();
      const splitBtn = document.createElement('button');
      splitBtn.textContent = 'P';
      splitBtn.className = transaction.isSplit ? 'btn-split active' : 'btn-split';
      splitBtn.onclick = function () { toggleRogersSplit(transaction.id); };
      splitCell.appendChild(splitBtn);

      const deleteCell = row.insertCell();
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.className = 'btn-delete';
      deleteBtn.onclick = function () { deleteRogersTransaction(transaction.id); };
      deleteCell.appendChild(deleteBtn);

      // Add row to table with animation
      addRowAnimation(row);
      rogersTableBody.appendChild(row);
    }

    // Toggle split status of a ROGERS transaction
    function toggleRogersSplit(id) {
      const index = rogersTransactions.findIndex(t => t.id === id);
      if (index === -1) return;
      const transaction = rogersTransactions[index];
      transaction.isSplit = !transaction.isSplit;
      transaction.expense = transaction.isSplit ? transaction.originalExpense / 2 : transaction.originalExpense;
      renderRogersTableWithFilters();
    }

    // Delete a ROGERS transaction
    function deleteRogersTransaction(id) {
      if (!confirm('Are you sure you want to delete this ROGERS transaction?')) return;
      const index = rogersTransactions.findIndex(t => t.id === id);
      if (index === -1) return;
      rogersTransactions.splice(index, 1);
      renderRogersTableWithFilters();
    }

    // Update ROGERS total amount display
    function updateRogersTotal(filteredTransactions) {
      const total = filteredTransactions.reduce((sum, t) => sum + t.expense, 0);
      rogersTotalAmountSpan.textContent = total.toFixed(2);
      updateGrandTotal();
    }

    // Process VISA CSV content - existing function kept as is
    function processCSV(csvContent) {
      const lines = csvContent.split('\n');
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;

        const columns = line.split(',');
        if (columns.length < 3) continue;

        // Parse date
        let date = null;
        try {
          // Handle MM/DD/YYYY format
          if (columns[0].includes('/')) {
            const parts = columns[0].trim().split('/');
            // Make sure we have at least month, day, year
            if (parts.length >= 3) {
              date = new Date(parts[2], parts[0] - 1, parts[1]);
            }
          } else {
            // Try standard date parsing
            date = new Date(columns[0].trim());
          }

          // Skip if date is invalid
          if (isNaN(date.getTime())) continue;
        } catch (err) {
          continue; // Skip on date parse error
        }

        // Parse name
        const name = columns[1].trim();
        if (!name) continue;

        // Parse expense
        const expense = parseFloat(columns[2].trim());
        if (isNaN(expense)) continue;

        // Check for duplicate (same date, name, and original amount)
        const isDuplicate = transactions.some(t =>
          t.date.toDateString() === date.toDateString() &&
          t.name === name &&
          Math.abs(t.originalExpense - expense) < 0.01
        );

        if (!isDuplicate) {
          transactions.push({
            id: Date.now() + '_' + Math.random().toString(36).substring(2, 9),
            date: date,
            name: name,
            expense: expense,
            originalExpense: expense,
            isSplit: false
          });
        }
      }
    }

    // Render table with filters applied
    function renderTableWithFilters() {
      // Clear the table first
      tableBody.innerHTML = '';

      // Get filter dates
      const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
      const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

      // Adjust date ranges to include full days
      if (startDate) startDate.setHours(0, 0, 0, 0);
      if (endDate) endDate.setHours(23, 59, 59, 999);

      // Filter transactions
      const filteredTransactions = transactions.filter(t => {
        if (startDate && t.date < startDate) return false;
        if (endDate && t.date > endDate) return false;
        return true;
      });

      // Render each transaction
      filteredTransactions.forEach(renderTransaction);

      // Update total
      updateTotal(filteredTransactions);
    }

    // Render a single transaction row
    function renderTransaction(transaction) {
      const row = document.createElement('tr');

      // Date cell
      const dateCell = document.createElement('td');
      dateCell.textContent = transaction.date.toLocaleDateString();
      row.appendChild(dateCell);

      // Name cell
      const nameCell = document.createElement('td');
      nameCell.textContent = transaction.name;
      row.appendChild(nameCell);

      // Expense cell
      const expenseCell = document.createElement('td');
      expenseCell.textContent = transaction.expense.toFixed(2);
      row.appendChild(expenseCell);

      // Split button cell
      const splitCell = document.createElement('td');
      const splitBtn = document.createElement('button');
      splitBtn.textContent = 'P';
      splitBtn.className = transaction.isSplit ? 'btn-split active' : 'btn-split';
      splitBtn.onclick = function () {
        toggleSplit(transaction.id);
      };
      splitCell.appendChild(splitBtn);
      row.appendChild(splitCell);

      // Delete button cell
      const deleteCell = document.createElement('td');
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.className = 'btn-delete';
      deleteBtn.onclick = function () {
        deleteTransaction(transaction.id);
      };
      deleteCell.appendChild(deleteBtn);
      row.appendChild(deleteCell);

      // Add row to table with animation
      addRowAnimation(row);
      tableBody.appendChild(row);
    }

    // Toggle split status of a transaction
    function toggleSplit(id) {
      const index = transactions.findIndex(t => t.id === id);
      if (index === -1) return;

      const transaction = transactions[index];
      transaction.isSplit = !transaction.isSplit;

      if (transaction.isSplit) {
        transaction.expense = transaction.originalExpense / 2;
      } else {
        transaction.expense = transaction.originalExpense;
      }

      // Re-render table to reflect changes
      renderTableWithFilters();
    }

    // Delete a transaction
    function deleteTransaction(id) {
      if (!confirm('Are you sure you want to delete this transaction?')) {
        return;
      }

      const index = transactions.findIndex(t => t.id === id);
      if (index === -1) return;

      transactions.splice(index, 1);
      renderTableWithFilters();
    }

    // Update total amount display
    function updateTotal(filteredTransactions) {
      const total = filteredTransactions.reduce((sum, t) => sum + t.expense, 0);
      totalAmountSpan.textContent = total.toFixed(2);
      updateGrandTotal();
    }

    // Calculate and display grand total
    function updateGrandTotal() {
      // Get current totals from spans
      const visaTotal = parseFloat(totalAmountSpan.textContent) || 0;
      const amexTotal = parseFloat(amexTotalAmountSpan.textContent) || 0;
      const rogersTotal = parseFloat(rogersTotalAmountSpan.textContent) || 0;

      // Calculate grand total
      const grandTotal = visaTotal + amexTotal + rogersTotal;

      // Update the grand total display
      document.getElementById('grandTotalAmount').textContent = grandTotal.toFixed(2);
    }

    // Add animation to newly rendered rows
    function addRowAnimation(row) {
      row.classList.add('fade-in');
      // Remove class after animation completes to avoid interference with other effects
      setTimeout(() => {
        row.classList.remove('fade-in');
      }, 500);
    }

    // Export current data to PDF
    function exportToPdf() {
      // Get current filter dates for filtering data in PDF
      const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
      const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

      // Adjust date ranges to include full days
      if (startDate) startDate.setHours(0, 0, 0, 0);
      if (endDate) endDate.setHours(23, 59, 59, 999);

      // Filter transactions
      const filteredVisaTransactions = transactions.filter(t => {
        if (startDate && t.date < startDate) return false;
        if (endDate && t.date > endDate) return false;
        return true;
      });

      const filteredAmexTransactions = amexTransactions.filter(t => {
        if (startDate && t.date < startDate) return false;
        if (endDate && t.date > endDate) return false;
        return true;
      });

      const filteredRogersTransactions = rogersTransactions.filter(t => {
        if (startDate && t.date < startDate) return false;
        if (endDate && t.date > endDate) return false;
        return true;
      });

      // Calculate totals
      const visaTotal = filteredVisaTransactions.reduce((sum, t) => sum + t.expense, 0);
      const amexTotal = filteredAmexTransactions.reduce((sum, t) => sum + t.expense, 0);
      const rogersTotal = filteredRogersTransactions.reduce((sum, t) => sum + t.expense, 0);
      const grandTotal = visaTotal + amexTotal + rogersTotal;

      try {
        // Create new jsPDF instance
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Add title
        doc.setFont("helvetica", "bold");
        doc.setFontSize(18);
        doc.text("Bank Transaction Report", doc.internal.pageSize.getWidth() / 2, 15, { align: "center" });

        // Add date range if applicable
        if (startDateInput.value || endDateInput.value) {
          doc.setFont("helvetica", "normal");
          doc.setFontSize(12);
          let dateRangeText = 'Date Range: ';
          if (startDateInput.value && endDateInput.value) {
            dateRangeText += `${startDateInput.value} to ${endDateInput.value}`;
          } else if (startDateInput.value) {
            dateRangeText += `From ${startDateInput.value}`;
          } else if (endDateInput.value) {
            dateRangeText += `To ${endDateInput.value}`;
          }
          doc.text(dateRangeText, doc.internal.pageSize.getWidth() / 2, 22, { align: "center" });
        }

        let yPos = 30;

        // Add VISA transactions if any
        if (filteredVisaTransactions.length > 0) {
          doc.setFont("helvetica", "bold");
          doc.setFontSize(14);
          doc.text("VISA Transactions", 14, yPos);
          yPos += 8;

          // Prepare table data
          const visaTableData = filteredVisaTransactions.map(t => [
            t.date.toLocaleDateString(),
            t.name,
            '$' + t.expense.toFixed(2),
            t.isSplit ? 'Yes' : 'No'
          ]);

          // Add table
          doc.autoTable({
            startY: yPos,
            head: [['Date', 'Name', 'Expenses', 'Split']],
            body: visaTableData,
            theme: 'grid',
            headStyles: { fillColor: [52, 152, 219], textColor: 255 },
            margin: { top: 10, right: 14, bottom: 10, left: 14 },
            styles: { overflow: 'linebreak' },
            columnStyles: {
              2: { halign: 'right' },
              3: { halign: 'center' }
            }
          });

          // Get Y position after table
          yPos = doc.lastAutoTable.finalY + 5;

          // Add VISA total
          doc.setFont("helvetica", "bold");
          doc.setFontSize(12);
          const visaTotalText = "Total VISA Expenses: $" + visaTotal.toFixed(2);
          doc.text(visaTotalText, doc.internal.pageSize.getWidth() - 14, yPos, { align: "right" });
          yPos += 10;
        }

        // Add page break if needed
        if (yPos > doc.internal.pageSize.getHeight() - 40) {
          doc.addPage();
          yPos = 20;
        }

        // Add AMEX transactions if any
        if (filteredAmexTransactions.length > 0) {
          doc.setFont("helvetica", "bold");
          doc.setFontSize(14);
          doc.text("AMEX Transactions", 14, yPos);
          yPos += 8;

          // Prepare table data
          const amexTableData = filteredAmexTransactions.map(t => [
            t.date.toLocaleDateString(),
            t.name,
            '$' + t.expense.toFixed(2),
            t.isSplit ? 'Yes' : 'No'
          ]);

          // Add table
          doc.autoTable({
            startY: yPos,
            head: [['Date', 'Name', 'Expenses', 'Split']],
            body: amexTableData,
            theme: 'grid',
            headStyles: { fillColor: [52, 152, 219], textColor: 255 },
            margin: { top: 10, right: 14, bottom: 10, left: 14 },
            styles: { overflow: 'linebreak' },
            columnStyles: {
              2: { halign: 'right' },
              3: { halign: 'center' }
            }
          });

          // Get Y position after table
          yPos = doc.lastAutoTable.finalY + 5;

          // Add AMEX total
          doc.setFont("helvetica", "bold");
          doc.setFontSize(12);
          const amexTotalText = "Total AMEX Expenses: $" + amexTotal.toFixed(2);
          doc.text(amexTotalText, doc.internal.pageSize.getWidth() - 14, yPos, { align: "right" });
          yPos += 10;
        }

        // Add page break if needed
        if (yPos > doc.internal.pageSize.getHeight() - 40) {
          doc.addPage();
          yPos = 20;
        }

        // Add ROGERS transactions if any
        if (filteredRogersTransactions.length > 0) {
          doc.setFont("helvetica", "bold");
          doc.setFontSize(14);
          doc.text("ROGERS Transactions", 14, yPos);
          yPos += 8;

          // Prepare table data
          const rogersTableData = filteredRogersTransactions.map(t => [
            t.date.toLocaleDateString(),
            t.name,
            '$' + t.expense.toFixed(2),
            t.isSplit ? 'Yes' : 'No'
          ]);

          // Add table
          doc.autoTable({
            startY: yPos,
            head: [['Date', 'Name', 'Expenses', 'Split']],
            body: rogersTableData,
            theme: 'grid',
            headStyles: { fillColor: [52, 152, 219], textColor: 255 },
            margin: { top: 10, right: 14, bottom: 10, left: 14 },
            styles: { overflow: 'linebreak' },
            columnStyles: {
              2: { halign: 'right' },
              3: { halign: 'center' }
            }
          });

          // Get Y position after table
          yPos = doc.lastAutoTable.finalY + 5;

          // Add ROGERS total
          doc.setFont("helvetica", "bold");
          doc.setFontSize(12);
          const rogersTotalText = "Total ROGERS Expenses: $" + rogersTotal.toFixed(2);
          doc.text(rogersTotalText, doc.internal.pageSize.getWidth() - 14, yPos, { align: "right" });
          yPos += 15;
        }

        // Add page break if needed for grand total
        if (yPos > doc.internal.pageSize.getHeight() - 30) {
          doc.addPage();
          yPos = 30;
        }

        // Add Grand Total box
        doc.setFillColor(52, 152, 219);
        doc.rect(doc.internal.pageSize.getWidth() / 2 - 50, yPos, 100, 20, 'F');
        doc.setTextColor(255);
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.text("GRAND TOTAL: $" + grandTotal.toFixed(2), doc.internal.pageSize.getWidth() / 2, yPos + 13, { align: "center" });

        // Reset text color and add footer
        doc.setTextColor(0);
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        const footer = `Report generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`;
        doc.text(footer, doc.internal.pageSize.getWidth() / 2, doc.internal.pageSize.getHeight() - 10, { align: "center" });

        // Save the PDF
        doc.save("bank_transactions_report.pdf");

        alert('PDF export completed successfully!');
      } catch (error) {
        console.error('PDF export error:', error);
        alert('Error generating PDF. Please check console for details.');
      }
    }
  </script>
</body>

</html>